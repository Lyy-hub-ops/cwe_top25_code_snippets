static void
cleanup_tags_file (const char* tagfile, const char* match_file_name)
{
  FILE *otags_f = fopen ("OTAGS", "wb");
  FILE *tag_f = fopen (tagfile, "rb");

  if (otags_f == NULL)
    pfatal ("OTAGS");

  if (tag_f == NULL)
    pfatal (tagfile);

  int buf_len = strlen (match_file_name) + sizeof ("\t\t ") + 1;
  char *buf = xmalloc (buf_len);
  snprintf (buf, buf_len, "\t%s\t", match_file_name);

  linebuffer line;
  linebuffer_init (&line);
  while (readline_internal (&line, tag_f, tagfile, true) > 0)
    {
      if (ferror (tag_f))
        pfatal (tagfile);

      if (strstr (line.buffer, buf) == NULL)
        {
          fprintf (otags_f, "%s\n", line.buffer);
          if (ferror (tag_f))
            pfatal (tagfile);
        }
    }
  free (buf);
  free (line.buffer);

  if (fclose (otags_f) == EOF)
    pfatal ("OTAGS");

  if (fclose (tag_f) == EOF)
    pfatal (tagfile);

  do_move_file ("OTAGS", tagfile);
  return;
}